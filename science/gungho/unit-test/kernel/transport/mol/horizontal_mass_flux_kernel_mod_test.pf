!-----------------------------------------------------------------------------
! (c) Crown copyright 2022 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

module horizontal_mass_flux_kernel_mod_test

  use constants_mod,                      only: i_def, r_def, l_def
  use horizontal_mass_flux_kernel_mod, only: horizontal_mass_flux_code
  use funit

  implicit none

  private

  public :: horizontal_mass_flux_kernel_test_type, test_all

  @TestCase
  type, extends(TestCase) :: horizontal_mass_flux_kernel_test_type
    private
  contains
    procedure test_all
  end type horizontal_mass_flux_kernel_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @Test
  subroutine test_all( this)

    implicit none

    class(horizontal_mass_flux_kernel_test_type), intent(inout) :: this

    integer(kind=i_def), parameter         :: nlayers = 1
    integer(kind=i_def), parameter         :: ndf_w2 = 4
    integer(kind=i_def), parameter         :: undf_w2 = nlayers*ndf_w2
    integer(kind=i_def), dimension(ndf_w2) :: map_w2
    integer(kind=i_def), parameter         :: ndf_md = 1
    integer(kind=i_def), parameter         :: ndata = 4
    integer(kind=i_def), parameter         :: undf_md = nlayers*ndata*ndf_md
    integer(kind=i_def), dimension(ndf_md) :: map_md


    real(kind=r_def), dimension(undf_w2) :: mass_flux
    real(kind=r_def), dimension(undf_w2) :: wind
    real(kind=r_def), dimension(undf_md) :: density

    real(kind=r_def), parameter :: tol = 1.0e-12_r_def

    integer(kind=i_def) :: k

    map_md(1) = 1
    map_w2(:) = (/1, nlayers+1, 2*nlayers+1, 3*nlayers+1 /)

    ! Set wind
    do k = 0, nlayers - 1
      wind(map_w2(1)+k) =  0.5431_r_def
      wind(map_w2(2)+k) =  2.6346_r_def
      wind(map_w2(3)+k) =  3.5436_r_def
      wind(map_w2(4)+k) = -7.0627_r_def
    end do

    ! Set density on edges
    do k = 0, nlayers - 1
      density(map_md(1) + k )             = 1.0_r_def
      density(map_md(1) + k +   nlayers ) = 2.0_r_def
      density(map_md(1) + k + 2*nlayers ) = 3.0_r_def
      density(map_md(1) + k + 3*nlayers ) = 4.0_r_def
   end do

   ! Set default flux
   mass_flux(:) = 0.0_r_def


   call horizontal_mass_flux_code(nlayers,   &
                                  mass_flux, &
                                  wind,      &
                                  density,   &
                                  ndf_w2,    &
                                  undf_w2,   &
                                  map_w2,    &
                                  ndf_md,    &
                                  undf_md,   &
                                  map_md )

  k = 0
  @assertEqual(mass_flux(map_w2(1)+k),  0.0_r_def)
  @assertEqual(mass_flux(map_w2(2)+k),  2.6346_r_def*2.0_r_def)
  @assertEqual(mass_flux(map_w2(3)+k),  3.5436_r_def*3.0_r_def)
  @assertEqual(mass_flux(map_w2(4)+k), -7.0627_r_def*4.0_r_def)

  end subroutine test_all

end module horizontal_mass_flux_kernel_mod_test
